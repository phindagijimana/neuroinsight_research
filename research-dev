#!/usr/bin/env bash
# ──────────────────────────────────────────────────────────────────────────────
#  NeuroInsight Research — DEVELOPMENT CLI
#
#  Usage:  ./research-dev <command> [options]
#
#  Development mode:
#    - Backend:  uvicorn --reload (auto-restart on code changes)
#    - Frontend: Vite dev server with HMR (hot module replacement)
#    - Celery:   debug-level logging
#
#  For production mode, use ./research instead.
# ──────────────────────────────────────────────────────────────────────────────
set -euo pipefail

MODE="development"
SELF_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SELF_DIR/.research-common.sh"

# ══════════════════════════════════════════════════════════════════════════════
#  START — Development
# ══════════════════════════════════════════════════════════════════════════════
cmd_start() {
    header
    ensure_dirs

    preflight_checks
    cmd_stop --quiet 2>/dev/null || true
    resolve_ports

    # ── Backend (Uvicorn — with --reload) ────────────────────────────────
    step "Backend  [DEV]  (port $BACKEND_PORT)"

    nohup python3 -m uvicorn backend.main:app \
        --host 0.0.0.0 \
        --port "$BACKEND_PORT" \
        --reload \
        --reload-dir backend \
        > "$LOG_DIR/backend.log" 2>&1 &
    write_pid backend $!
    info "PID $! — auto-reload enabled"
    info "Waiting for health check ..."

    if wait_for_url "http://localhost:$BACKEND_PORT/health" 25 "backend"; then
        success "Backend ready  ->  http://localhost:$BACKEND_PORT"
    else
        error "Backend failed to start. See: $LOG_DIR/backend.log"
        exit 1
    fi

    # ── Celery worker (debug level) ──────────────────────────────────────
    step "Celery worker  [DEV]  (concurrency=$CELERY_CONCURRENCY)"

    nohup python3 -m celery \
        -A backend.core.celery_app worker \
        --loglevel=debug \
        --concurrency="$CELERY_CONCURRENCY" \
        -Q docker_jobs,celery \
        --hostname="neuroinsight-worker@%h" \
        > "$LOG_DIR/celery.log" 2>&1 &
    write_pid celery $!
    info "PID $! — debug logging enabled"

    sleep 3
    if is_pid_alive "$(read_pid celery)"; then
        success "Celery worker running"
    else
        warn "Celery worker may have failed — check: $LOG_DIR/celery.log"
    fi

    # ── Frontend (Vite dev server with HMR) ──────────────────────────────
    step "Frontend  [DEV]  (port $FRONTEND_PORT)"

    if [ -d "frontend" ]; then
        # Patch Vite proxy target to match actual backend port
        local VITE_CFG="frontend/vite.config.ts"
        if [ -f "$VITE_CFG" ]; then
            sed -i "s|target: 'http://localhost:[0-9]*'|target: 'http://localhost:$BACKEND_PORT'|g" "$VITE_CFG"
        fi

        (cd frontend && nohup npx vite \
            --port "$FRONTEND_PORT" \
            --host 0.0.0.0 \
            > "../$LOG_DIR/frontend.log" 2>&1 &
        write_pid frontend $!)

        if wait_for_url "http://localhost:$FRONTEND_PORT" 15 "frontend"; then
            success "Frontend ready  ->  http://localhost:$FRONTEND_PORT  (HMR)"
        else
            warn "Frontend may still be starting — check: $LOG_DIR/frontend.log"
        fi
    else
        warn "frontend/ not found — skipping"
    fi

    print_start_summary "DEVELOPMENT"
}

dispatch "$@"
