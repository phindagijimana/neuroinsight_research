# Plugin 9: QSIRecon
id: qsirecon
name: "QSIRecon"
version: "1.1.1"
type: plugin
domain: diffusion_mri

visibility:
  user_selectable: true
  ui_category: primary
  ui_label: "QSIRecon"

description: >
  Diffusion reconstruction, tractography, and connectome generation.
  Operates on QSIPrep derivatives. Supports multiple reconstruction
  methods (CSD, DTI, NODDI, MAPMRI).

authors:
  - "NeuroInsight Research Team"
  - "Based on QSIRecon (Cieslak et al., 2021)"

references:
  - "Cieslak, M., et al. (2021). QSIPrep: an integrative platform for preprocessing and reconstructing diffusion MRI data. Nature Methods, 18(7), 775-778."

container:
  runtime: docker
  image: "pennlinc/qsirecon:1.1.1"
  digest: "sha256:f3eaa8f8f8b2e84f2fb4d5f83b069bec59a7ba657efb7fe1e782b5ca7aeb2657"

inputs:
  required:
    - key: qsiprep_derivatives
      type: path
      description: "QSIPrep derivatives directory"
    - key: subject_id
      type: string
      description: "Subject identifier (without 'sub-' prefix)"
  optional:
    - key: fs_license
      type: path
      description: "FreeSurfer license file path"

input_format:
  format_name: "QSIPrep Derivatives"
  description: "Output directory from a completed QSIPrep run."
  notes:
    - "Must be a valid QSIPrep derivatives directory"
    - "Contains preprocessed DWI, b-tables, and QC outputs"
    - "Run QSIPrep first, then point QSIRecon to its output"
  example_structure: |
    qsiprep_derivatives/
      dataset_description.json
      sub-01/
        dwi/
          sub-01_space-T1w_desc-preproc_dwi.nii.gz
          sub-01_space-T1w_desc-preproc_dwi.bval
          sub-01_space-T1w_desc-preproc_dwi.bvec
        anat/
          sub-01_desc-preproc_T1w.nii.gz
  file_types:
    - ".nii.gz (preprocessed DWI and anatomical)"
    - ".bval / .bvec (diffusion gradient tables)"

parameters:
  - name: recon_spec
    type: choice
    default: mrtrix_multishell_msmt
    choices: ["mrtrix_multishell_msmt", "mrtrix_singleshell_ss3t", "dipy_dki", "dipy_mapmri", "csd"]
    description: "Reconstruction pipeline specification"

resources:
  profiles:
    default:
      cpus: 8
      mem_gb: 32
      time_hours: 4
      gpus: 0

execution:
  style: single_stage
  workdirs:
    native_root: "{run_root}/native/qsirecon"
    logs_dir: "{run_root}/logs/qsirecon"

  stages:
    - id: qsirecon_run
      kind: single
      profile: default
      command_template: |
        #!/bin/bash
        set -e

        mkdir -p /data/outputs/native/qsirecon
        mkdir -p /data/outputs/logs/qsirecon

        qsirecon \
          /data/inputs/qsiprep_derivatives \
          /data/outputs/native/qsirecon \
          participant \
          --participant-label {subject_id} \
          --recon-spec {recon_spec} \
          --nthreads {threads} \
          --omp-nthreads {omp_nthreads}

        echo "QSIRecon completed successfully"

native_outputs:
  preserved: true
  layout: "native/qsirecon/sub-{subject_id}/"

bundle:
  bundle_version: 1
  root: "{run_root}/bundle"
  extraction:
    volumes:
      - from: "{native_root}/sub-{subject_id}/dwi/*FA*.nii.gz"
        to: "{bundle.root}/volumes/"
        method: copy
      - from: "{native_root}/sub-{subject_id}/dwi/*MD*.nii.gz"
        to: "{bundle.root}/volumes/"
        method: copy
    metrics:
      - from: "{native_root}/sub-{subject_id}/dwi/*connectome*.csv"
        to: "{bundle.root}/metrics/"
        method: copy
    qc:
      - from: "{native_root}/sub-{subject_id}/figures/*.svg"
        to: "{bundle.root}/qc/"
        method: copy

provenance:
  write_run_manifest: true
  record_exact_commands: true
  record_container_digest: true
  record_inputs_hashes: true
