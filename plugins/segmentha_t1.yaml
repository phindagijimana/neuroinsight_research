# Plugin 4: FreeSurfer SegmentHA_T1
id: segmentha_t1
name: "FreeSurfer SegmentHA_T1"
version: "7.4.1"
type: plugin
domain: structural_mri

visibility:
  user_selectable: true
  ui_category: primary
  ui_label: "FreeSurfer SegmentHA_T1"

description: >
  Segment hippocampal subfields and amygdala nuclei from T1-weighted MRI
  using FreeSurfer's segmentHA_T1.sh. Requires prior recon-all output.

authors:
  - "NeuroInsight Research Team"
  - "Based on FreeSurfer (Iglesias et al., 2015)"

references:
  - "Iglesias, J.E. et al. (2015). A computational atlas of the hippocampal formation using ex vivo, ultra-high resolution MRI. Neuroimage, 115, 117-137."

container:
  runtime: docker
  image: "freesurfer/freesurfer:7.4.1"
  digest: null

inputs:
  required:
    - key: subjects_dir
      type: path
      description: "FreeSurfer SUBJECTS_DIR (recon-all completed)"
    - key: subject_id
      type: string
      description: "Subject identifier within SUBJECTS_DIR"
  optional:
    - key: fs_license
      type: path
      description: "FreeSurfer license file path"

parameters:
  - name: threads
    type: int
    default: 4
    min_value: 1
    max_value: 16
    description: "Number of CPU threads"

resources:
  profiles:
    default:
      cpus: 4
      mem_gb: 16
      time_hours: 2
      gpus: 0

execution:
  style: single_stage
  workdirs:
    native_root: "{inputs.subjects_dir}"
    logs_dir: "{run_root}/logs/segmentha_t1"
  environment:
    SUBJECTS_DIR: "{inputs.subjects_dir}"
    FS_LICENSE: "{inputs.fs_license}"

  stages:
    - id: segment_ha_t1
      kind: single
      profile: default
      command_template: |
        #!/bin/bash
        set -e

        export SUBJECTS_DIR=/data/inputs/subjects_dir
        mkdir -p /data/outputs/logs/segmentha_t1

        # Run hippocampal subfield segmentation (T1 only)
        segmentHA_T1.sh {subject_id}

        echo "SegmentHA_T1 completed successfully"

native_outputs:
  preserved: true
  layout: "SUBJECTS_DIR/{subject_id}/mri/"

bundle:
  bundle_version: 1
  root: "{run_root}/bundle"
  extraction:
    conversions:
      - from: "{native_root}/{subject_id}/mri/lh.hippoAmygLabels-T1.v22.mgz"
        to: "{bundle.root}/volumes/lh_hippo_subfields.nii.gz"
        method: "mri_convert"
      - from: "{native_root}/{subject_id}/mri/rh.hippoAmygLabels-T1.v22.mgz"
        to: "{bundle.root}/volumes/rh_hippo_subfields.nii.gz"
        method: "mri_convert"
    metrics:
      - from: "{native_root}/{subject_id}/mri/lh.hippoSfVolumes-T1.v22.txt"
        to: "{bundle.root}/metrics/lh_hippo_volumes.json"
        method: "parse_hippo_stats"
      - from: "{native_root}/{subject_id}/mri/rh.hippoSfVolumes-T1.v22.txt"
        to: "{bundle.root}/metrics/rh_hippo_volumes.json"
        method: "parse_hippo_stats"

provenance:
  write_run_manifest: true
  record_exact_commands: true
  record_container_digest: true
  record_inputs_hashes: true
