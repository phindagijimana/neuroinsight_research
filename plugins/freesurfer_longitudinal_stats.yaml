# Plugin 12: FreeSurfer Longitudinal Stats (Hidden Utility)
id: freesurfer_longitudinal_stats
name: "FreeSurfer Longitudinal Stats Utility"
version: "1.0.0"
type: plugin
domain: structural_mri

visibility:
  user_selectable: false
  ui_category: internal_utility
  ui_label: "Longitudinal Stats Utility"

description: >
  Utility plugin for post-processing existing FreeSurfer longitudinal
  outputs. Hidden from UI plugin list. Invoked by workflows only.
  Generates QDEC-style tables and optional slopes summaries.

authors:
  - "NeuroInsight Research Team"

references:
  - "https://surfer.nmr.mgh.harvard.edu/fswiki/FsTutorial/LongitudinalTutorial"

container:
  runtime: docker
  image: "freesurfer/freesurfer:7.4.1"
  digest: "sha256:10b6468cbd9fcd2db3708f4651d59ad75d4da849a2c5d8bb6dba217f08b8c46b"

inputs:
  required:
    - key: subjects_dir
      type: path
      description: "SUBJECTS_DIR containing LONG dirs"
    - key: base_id
      type: string
      description: "Base template identifier"
  optional:
    - key: fs_license
      type: path
      description: "FreeSurfer license file path"

input_format:
  format_name: "FreeSurfer Longitudinal SUBJECTS_DIR"
  description: "A FreeSurfer SUBJECTS_DIR containing longitudinal processing output."
  notes:
    - "Must contain the base template and all longitudinal directories"
    - "Generated by the FreeSurfer Longitudinal plugin"
  example_structure: |
    subjects_dir/
      sub-01_ses-01/              (cross-sectional)
      sub-01_ses-02/              (cross-sectional)
      sub-01_base/                (unbiased template)
      sub-01_ses-01.long.sub-01_base/   (longitudinal)
      sub-01_ses-02.long.sub-01_base/   (longitudinal)
  file_types:
    - ".mgz (FreeSurfer volume format)"
    - "*.stats (FreeSurfer statistics files)"

parameters:
  - name: base_id
    type: string
    default: "base_template"
    description: "Identifier for the unbiased base template"

resources:
  profiles:
    default:
      cpus: 4
      mem_gb: 16
      time_hours: 2
      gpus: 0

execution:
  style: single_stage
  command_template: |
    #!/bin/bash
    set -e
    export SUBJECTS_DIR=/data/inputs/subjects_dir
    export BASE_ID={base_id}
    OUT=/data/outputs/bundle/metrics
    mkdir -p "$OUT"
    mkdir -p /data/outputs/logs/freesurfer_longitudinal_stats
    echo "=== Extracting longitudinal stats ==="
    echo "SUBJECTS_DIR: $SUBJECTS_DIR"
    echo "BASE_ID: $BASE_ID"
    LONG_DIRS=()
    for d in "$SUBJECTS_DIR"/*.long."$BASE_ID"; do
      [ -d "$d" ] || continue
      LONG_DIRS+=("$(basename "$d")")
      echo "  Found LONG dir: $(basename "$d")"
    done
    if [ ${#LONG_DIRS[@]} -eq 0 ]; then
      echo "ERROR: No longitudinal directories found matching *.long.$BASE_ID"
      exit 1
    fi
    echo "=== Copying per-timepoint stats ==="
    for long_dir in "${LONG_DIRS[@]}"; do
      tp_id="${long_dir%%.long.*}"
      stats_file="$SUBJECTS_DIR/$long_dir/stats/aseg.stats"
      if [ -f "$stats_file" ]; then
        echo "  Extracting stats for $tp_id"
        mkdir -p "$OUT/$tp_id"
        cp "$stats_file" "$OUT/$tp_id/aseg.stats"
      fi
    done
    echo "=== Generating longitudinal summary ==="
    python3 -c "import os,json,glob; sd=os.environ['SUBJECTS_DIR']; bi=os.environ['BASE_ID']; out=os.environ.get('OUT','$OUT'); s={'base_id':bi,'timepoints':[]}; [s['timepoints'].append({'tp_id':os.path.basename(d).split('.long.')[0],'stats_file':os.path.join(d,'stats','aseg.stats')}) for d in sorted(glob.glob(os.path.join(sd,'*.long.'+bi)))]; json.dump(s,open(os.path.join(out,'longitudinal_summary.json'),'w'),indent=2); print('Written summary with %d timepoints'%len(s['timepoints']))"
    echo "=== Longitudinal stats extraction completed ==="

bundle:
  bundle_version: 1
  root: "/data/outputs/bundle"
  extraction:
    metrics:
      - from: "/data/outputs/bundle/metrics/longitudinal_summary.json"
        to: "/data/outputs/bundle/metrics/longitudinal_summary.json"
        method: identity

provenance:
  write_run_manifest: true
  record_exact_commands: true
  record_container_digest: true
