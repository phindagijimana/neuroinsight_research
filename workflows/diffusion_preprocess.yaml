# Workflow 7: Diffusion MRI Preprocessing
id: diffusion_preprocess
name: "Diffusion MRI Preprocessing"
version: "1.0.0"
type: workflow
domain: diffusion_mri

description: >
  Preprocessing of diffusion MRI data using QSIPrep. Produces
  corrected DWI, brain mask, and QC reports.

developer_contract: >
  Workflows only orchestrate plugins. No direct execution steps allowed.

inputs:
  required:
    - key: bids_dir
      type: directory
      description: "BIDS-formatted dataset directory with DWI data"
    - key: subject_id
      type: string
      description: "Subject identifier (without 'sub-' prefix)"
  optional:
    - key: fs_license
      type: path
    - key: output_resolution
      type: float
      default: 1.5

input_format:
  format_name: "BIDS (with DWI)"
  description: "BIDS dataset with diffusion-weighted imaging data."
  example_structure: |
    bids_dir/
      dataset_description.json
      sub-01/
        dwi/
          sub-01_dwi.nii.gz
          sub-01_dwi.bval
          sub-01_dwi.bvec
        anat/
          sub-01_T1w.nii.gz

validation:
  preflight_checks:
    - "directory_exists(bids_dir)"
    - "bids_has_dwi(bids_dir, subject_id)"

steps:
  - id: qsiprep
    uses: qsiprep
    with:
      bids_dir: "{inputs.bids_dir}"
      subject_id: "{inputs.subject_id}"
      fs_license: "{inputs.fs_license}"
      output_resolution: "{inputs.output_resolution}"

outputs:
  native:
    - "{run_root}/native/qsiprep"
  bundle:
    - "{run_root}/bundle"

reproducibility:
  pin_containers: true
  write_run_manifest: true
  store_exact_commands: true
