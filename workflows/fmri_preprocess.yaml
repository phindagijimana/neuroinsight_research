# Workflow 5: fMRI Preprocessing
id: fmri_preprocess
name: "fMRI Preprocessing"
version: "1.0.0"
type: workflow
domain: functional_mri

description: >
  Preprocessing of functional MRI data using fMRIPrep. Produces
  preprocessed BOLD, confound regressors, and QC reports.

developer_contract: >
  Workflows only orchestrate plugins. No direct execution steps allowed.

inputs:
  required:
    - key: bids_dir
      type: directory
      description: "BIDS-formatted dataset directory"
    - key: subject_id
      type: string
      description: "Subject identifier (without 'sub-' prefix)"
  optional:
    - key: fs_license
      type: path
    - key: output_spaces
      type: string
      default: "MNI152NLin2009cAsym"

validation:
  preflight_checks:
    - "directory_exists(bids_dir)"
    - "bids_valid(bids_dir)"

steps:
  - id: fmriprep
    uses: fmriprep
    with:
      bids_dir: "{inputs.bids_dir}"
      subject_id: "{inputs.subject_id}"
      fs_license: "{inputs.fs_license}"
      output_spaces: "{inputs.output_spaces}"

outputs:
  native:
    - "{run_root}/native/fmriprep"
  bundle:
    - "{run_root}/bundle"

reproducibility:
  pin_containers: true
  write_run_manifest: true
  store_exact_commands: true
