# Workflow 6: fMRI Full Pipeline (Preprocess + Postprocess)
id: fmri_full
name: "fMRI Full Pipeline"
version: "1.0.0"
type: workflow
domain: functional_mri

description: >
  Complete fMRI analysis: fMRIPrep preprocessing followed by XCP-D
  postprocessing. Produces denoised BOLD, connectivity matrices,
  parcellated timeseries, and QA metrics.

developer_contract: >
  Workflows only orchestrate plugins. No direct execution steps allowed.

inputs:
  required:
    - key: bids_dir
      type: directory
      description: "BIDS-formatted dataset directory"
    - key: subject_id
      type: string
      description: "Subject identifier (without 'sub-' prefix)"
  optional:
    - key: fs_license
      type: path
    - key: output_spaces
      type: string
      default: "MNI152NLin2009cAsym"
    - key: smoothing
      type: float
      default: 6.0
    - key: fd_threshold
      type: float
      default: 0.3

input_format:
  format_name: "BIDS"
  description: "BIDS dataset with functional BOLD and anatomical T1w scans."
  example_structure: |
    bids_dir/
      dataset_description.json
      sub-01/
        anat/
          sub-01_T1w.nii.gz
        func/
          sub-01_task-rest_bold.nii.gz
          sub-01_task-rest_bold.json

validation:
  preflight_checks:
    - "directory_exists(bids_dir)"
    - "bids_valid(bids_dir)"

steps:
  - id: fmriprep
    uses: fmriprep
    with:
      bids_dir: "{inputs.bids_dir}"
      subject_id: "{inputs.subject_id}"
      fs_license: "{inputs.fs_license}"
      output_spaces: "{inputs.output_spaces}"

  - id: xcpd
    uses: xcpd
    with:
      fmriprep_derivatives: "{step.fmriprep.outputs.native_root}"
      subject_id: "{inputs.subject_id}"
      fs_license: "{inputs.fs_license}"
      smoothing: "{inputs.smoothing}"
      fd_threshold: "{inputs.fd_threshold}"

outputs:
  native:
    - "{run_root}/native/fmriprep"
    - "{run_root}/native/xcpd"
  bundle:
    - "{run_root}/bundle"

reproducibility:
  pin_containers: true
  write_run_manifest: true
  store_exact_commands: true
